var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,l=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,s=(e,t)=>{for(var n in t||(t={}))a.call(t,n)&&l(e,n,t[n]);if(r)for(var n of r(t))o.call(t,n)&&l(e,n,t[n]);return e},c=(e,r)=>t(e,n(r)),i=(e,t)=>{var n={};for(var l in e)a.call(e,l)&&t.indexOf(l)<0&&(n[l]=e[l]);if(null!=e&&r)for(var l of r(e))t.indexOf(l)<0&&o.call(e,l)&&(n[l]=e[l]);return n};import{r as u,p as m,R as p,b as d,N as f,S as h,a as g,H as y,c as b}from"./vendor.69da2182.js";const x=u.exports.createContext();function E({children:e}){const[t,n]=u.exports.useState();return p.createElement(x.Provider,{value:{loginData:t,setLoginData:n}},e)}E.propTypes={children:m.exports.node.isRequired};const v=()=>u.exports.useContext(x),w=(e,t)=>{const{git:n}=t,r=c(s({},e),{err:null});switch(n){case"commit":{const{content:e}=t;return c(s({},r),{content:e,isUpToDate:!1})}case"did fetch":{const{content:e=r.content,sha:n}=t;return c(s({},r),{content:e,isFetching:!1,isUpToDate:!0,sha:n})}case"failed fetch":{const{err:e}=t;return c(s({},r),{err:e,isFetching:!1})}case"will fetch":return c(s({},r),{isFetching:!0});default:throw new Error}},C=e=>e&&`Bearer ${e}`,k={afterPull:e=>e,beforePush:e=>e,branch:"main"},N=[],T=u.exports.createContext();function D({children:e}){const{loginData:t}=v(),[n,r,a]=((e,t,n,r=k)=>{const{token:a,initialContent:o,afterPull:l,beforePush:c,branch:i}=s(s({},k),r),[{content:m,err:p,isFetching:f,isUpToDate:h,sha:g},y]=u.exports.useReducer(w,{content:o}),b=e&&t&&n&&`https://api.github.com/repos/${e}/${t}/contents/${n}`;return u.exports.useEffect((()=>{if(b){const e=b&&`${b}?ref=${i}`;y({git:"will fetch"}),fetch(e,{headers:{Authorization:C(a),Accept:"application/vnd.github.v3+json"}}).then((e=>{if(e.ok)return e.json();throw new Error})).then((({content:e,sha:t})=>{const n=d.Buffer.from(e,"base64"),r=JSON.parse(n),a=l(r);y({git:"did fetch",content:a,sha:t})})).catch((e=>y({git:"failed fetch",err:e})))}}),[l,i,b,a]),[m,e=>y({git:"commit",content:e}),{err:p,isFetching:f,isUpToDate:h,push:()=>{if(!h&&!f&&m&&g&&b){const e=c(m),t=JSON.stringify(e),r=d.Buffer.from(t).toString("base64");y({git:"will fetch"}),fetch(b,{method:"put",headers:{Authorization:C(a),"Content-Type":"application/json"},body:JSON.stringify({message:`updated ${n}`,content:r,sha:g,branch:i})}).then((e=>{if(e.ok)return e.json();throw new Error})).then((({content:{sha:e}})=>y({git:"did fetch",sha:e}))).catch((e=>y({git:"failed fetch",err:e})))}}}]})(null==t?void 0:t.username,"elo-ludo","data.json",{token:null==t?void 0:t.pat,initialContent:N,branch:"data"}),o=!a.isUpToDate;return p.createElement(T.Provider,{value:{games:n.filter((({type:e})=>"goodie"!==e&&"accessoire"!==e)).map((e=>(null==e.elo&&(e.elo=1500),e))),addGame:e=>{r([...n,c(s({},e),{elo:1500,matchCount:0})])},hasSomethingToSave:o,removeGame:({id:e})=>{r(n.filter((t=>t.id!==e)))},saveGames:()=>{a.push()},updateGames:(...e)=>{r(n.map((t=>{var n;return null!=(n=e.find((({id:e})=>e===t.id)))?n:t})))}}},e)}D.propTypes={children:m.exports.node.isRequired};const S=()=>u.exports.useContext(T),P={afterFetch:()=>{},beforeFetch:()=>{},extractData:e=>e,extractBody:e=>e.json()};const j={initialState:[],extractData:e=>e.list},R=u.exports.createContext();function F({children:e}){const[t,n]=u.exports.useState(),[r]=function(e,t=P){const{afterFetch:n,beforeFetch:r,extractBody:a,extractData:o,fetchOptions:l,initialState:c}=s(s({},P),t),[i,m]=u.exports.useState(c),[p,d]=u.exports.useState();return u.exports.useEffect((()=>{e&&(r(),fetch(e,l).then((e=>e.ok&&a(e))).then((e=>e&&m(o(e)))).catch((e=>d(e))).finally(n))}),[n,r,a,o,l,e]),[i,p]}(t,j);return p.createElement(R.Provider,{value:{results:r,setQuery:e=>{n(`https://www.myludo.fr/views/profil/datas.php?type=collection&id=${e}`)}}},e)}F.propTypes={children:m.exports.node.isRequired};const O=()=>u.exports.useContext(R);function $({opener:e,children:t}){const[n,r,a]=(()=>{const[e,t]=u.exports.useState(!1);return[e,()=>t(!0),()=>t(!1)]})();return u.exports.useEffect((()=>{const e=({key:e})=>{"Escape"===e&&a()};return n&&window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}}),[a,n]),p.createElement(p.Fragment,null,p.cloneElement(e,{onClick:r}),n&&p.createElement("div",{className:"fixed top-0 left-0 w-screen h-screen bg-black bg-opacity-75 grid",style:{gridTemplateColumns:"1fr auto 1fr",gridTemplateRows:"1fr auto 1fr"}},p.createElement("button",{className:"col-start-3 justify-self-start self-end",type:"button",onClick:a},"x"),p.createElement("div",{className:"col-start-2 row-start-2"},t)))}function q(){const e=u.exports.useRef(),t=u.exports.useRef(),{setLoginData:n}=v();return p.createElement($,{opener:p.createElement("button",{className:"link",type:"button"},"Login")},p.createElement("form",{onSubmit:r=>{r.preventDefault(),fetch("https://api.github.com",{method:"head",headers:{authorization:`Bearer ${t.current.value}`}}).then((r=>{r.ok&&"public_repo"===r.headers.get("X-OAuth-Scopes")?n({username:e.current.value,pat:t.current.value}):alert("failed to use token")}))},className:"p-4 rounded-lg bg-white space-y-4"},p.createElement("div",{className:"space-y-2"},p.createElement("label",{htmlFor:"username"},"username"),p.createElement("input",{className:"focus:border-light-blue-500 focus:ring-1 focus:ring-light-blue-500 focus:outline-none w-full text-sm text-black placeholder-gray-500 border border-gray-200 rounded-md py-2 px-1",ref:e,id:"username",type:"text"})),p.createElement("div",{className:"space-y-2"},p.createElement("label",{htmlFor:"pat"},"PAT"),p.createElement("input",{className:"focus:border-light-blue-500 focus:ring-1 focus:ring-light-blue-500 focus:outline-none w-full text-sm text-black placeholder-gray-500 border border-gray-200 rounded-md py-2 px-1",ref:t,id:"pat",type:"password"})),p.createElement("div",null,p.createElement("button",{type:"submit"},"Validate"))))}function A(){const{setLoginData:e}=v();return p.createElement("button",{className:"link",type:"button",onClick:()=>e(null)},"Logout")}function G(){const{hasSomethingToSave:e,saveGames:t}=S();return p.createElement("button",{className:"link",type:"button",onClick:t,disabled:!e},"Save")}function W({className:e}){const{loginData:t}=v();return p.createElement("div",{className:`flex flex-row justify-end shadow-b mr-2 sm:mr-0 ${e}`},null==t?p.createElement(q,null):p.createElement(p.Fragment,null,p.createElement(G,null),p.createElement(A,null)))}$.propTypes={opener:m.exports.node.isRequired,children:m.exports.node.isRequired},W.propTypes={className:m.exports.string},W.defaultProps={className:""};const L=(e,t)=>p.createElement("li",null,p.createElement(f,{to:e,exact:!0,activeClassName:"active",className:"link"},t));function M({className:e}){return p.createElement("nav",{className:e},p.createElement("ul",{className:"flex flex-row justify-evenly sm:justify-start shadow-t sm:shadow-b"},L("/","Home"),L("/play","Play"),L("/search","Search")))}M.propTypes={className:m.exports.string},M.defaultProps={className:""};function B({children:e,data:t}){const{elo:n,image:{S300:r},lastDelta:a,lastPlayedAt:o,matchCount:l,title:s}=t;return p.createElement("figure",{className:"sm:inline-flex shadow overflow-hidden rounded-xl sm:p-0 sm:h-72"},r&&p.createElement("img",{loading:"lazy",src:r,alt:s,className:"block sm:w-48 h-auto"}),p.createElement("figcaption",{className:"flex flex-col sm:w-96 p-4 sm:p-8 text-center sm:text-left space-y-2"},p.createElement("p",{className:"font-semibold"},s),n&&a&&p.createElement("p",null,(e=>null==e?void 0:e.toFixed(1))(n),(e=>null==e?null:((e=e.toFixed(1))>0&&(e=`+${e}`),` (${e})`))(a),(e=>null==e?null:` / ${e}`)(l),(e=>null==e?null:` : ${new Date(e)}`)(o)),e))}function U({games:e,gameComponentType:t}){return p.createElement("ol",{className:"grid grid-cols-1 sm:grid-cols-auto-fit gap-y-4 justify-items-center"},e.map((e=>p.createElement("li",{key:e.id},p.createElement(t,{data:e})))))}function z(){const{games:e}=S(),t=e.reduce(((e,t)=>t.elo>e?t.elo:e),0);return p.createElement(U,{games:e.sort(((e,t)=>t.elo-e.elo||t.matchCount-e.matchCount||t.lastDelta-e.lastDelta)),gameComponentType:({data:e})=>{const n=7+3*(e.elo-1500)/(t-1500);return p.createElement(B,{data:e},p.createElement("strong",null,Math.round(2*n)/2))}})}function J({data:e,onWin:t}){return p.createElement(B,{data:e},p.createElement("button",{type:"button",onClick:t},"WIN"))}B.propTypes={children:m.exports.node,data:m.exports.shape({elo:m.exports.number,id:m.exports.string.isRequired,image:m.exports.shape({S300:m.exports.string.isRequired}).isRequired,lastDelta:m.exports.number,lastPlayedAt:m.exports.number,matchCount:m.exports.number,title:m.exports.string.isRequired}).isRequired},U.propTypes={games:m.exports.arrayOf(B.propTypes.data).isRequired,gameComponentType:m.exports.elementType},U.defaultProps={gameComponentType:B},J.propTypes=c(s({},B.propTypes),{onWin:m.exports.func.isRequired});const H={DMax:400,kGenerator:({matchCount:e})=>e<30?32:24},I=(({DMax:e,kGenerator:t}=H)=>n=>{var r=i(n,[]);const a=({elo:t})=>{var n;return 1/(1+10**(-(n=r.elo-t,{between:(e,t)=>Math.max(Math.min(n,t),e)}).between(-e,e)/e))},o=e=>n=>{var o,l,u=i(n,[]);r.matchCount=null!=(o=r.matchCount)?o:0,r.k=t(r),r.didWin=e,r.p=a(u),u.matchCount=null!=(l=u.matchCount)?l:0,u.k=t(u),u.didWin=1-r.didWin,u.p=1-r.p;const m=e=>{var t=e,{elo:n,matchCount:r,k:a,didWin:o,p:l}=t,u=i(t,["elo","matchCount","k","didWin","p"]);const m=n+a*(o-l);return c(s({},u),{elo:m,matchCount:r+1,lastDelta:m-n,lastPlayedAt:Date.now()})};return[m(r),m(u)]};return{wins:o(1),ties:o(.5),loses:o(0),oddsAgainst:a}})(),Q=()=>Math.random()-.5;function V(){const{games:e,updateGames:t}=S();if(e.length<10)return p.createElement("p",null,"you should start with searching games ;)");const n=[Q,(e,t)=>{var n,r;return(null!=(n=e.matchCount)?n:0)-(null!=(r=t.matchCount)?r:0)},(e,t)=>{var n,r;return new Date(null!=(n=e.lastPlayedAt)?n:0).getTime()-new Date(null!=(r=t.lastPlayedAt)?r:0).getTime()}].sort(Q);let[r,,a]=e.sort(n[0]);return p.createElement(p.Fragment,null,p.createElement(J,{data:r,onWin:()=>{[r,a]=I(r).wins(a),t(r,a)}}),"vs",p.createElement(J,{data:a,onWin:()=>{[a,r]=I(a).wins(r),t(r,a)}}),p.createElement("button",{type:"button",onClick:()=>{[r,a]=I(r).ties(a),t(r,a)}},"=="))}function X(){const{setQuery:e}=O(),t=u.exports.useRef();return p.createElement("form",{onSubmit:n=>{n.preventDefault(),e(t.current.value)}},p.createElement("label",{htmlFor:"myludo"},"Myludo id"),p.createElement("input",{ref:t,id:"myludo"}),p.createElement("button",{type:"submit"},"Search"))}function _({data:e}){const{id:t}=e,{games:n,addGame:r,removeGame:a}=S(),o={[!0]:{onClick:()=>a(e),text:"-"},[!1]:{onClick:()=>r(e),text:"+"}},l=null!=n.find((e=>e.id===t));return p.createElement(B,{data:e},p.createElement("button",{type:"button",onClick:o[l].onClick},o[l].text))}function K(){const{results:e}=O();return p.createElement(U,{games:e,gameComponentType:_})}function Y(){return p.createElement(F,null,p.createElement(X,null),p.createElement(K,null))}_.propTypes=s({},B.propTypes);const Z=(e,t)=>p.createElement(g,{exact:!0,path:e,component:t});function ee(){return p.createElement(h,null,Z("/",z),Z("/play",V),Z("/search",Y))}function te(){return p.createElement(E,null,p.createElement(D,null,p.createElement(y,null,p.createElement(M,{className:"row-start-3 sm:row-auto sticky bottom-0 sm:top-0 bg-white"}),p.createElement(W,{className:"sticky top-0 bg-white"}),p.createElement("main",{className:"col-span-full p-4"},p.createElement(ee,null)))))}b.render(p.createElement(te,null),document.querySelector("#root"));
